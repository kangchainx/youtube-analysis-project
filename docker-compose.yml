services:
  frontend:
    build:
      context: .
      args:
        VITE_API_BASE_URL: /api
        VITE_YOUTUBE_API_KEY: ${VITE_YOUTUBE_API_KEY:-}
    image: youtube-analysis-frontend:latest
    depends_on:
      backend:
        condition: service_started
    ports:
      - "8080:80"
    volumes:
      - ./docker/nginx.compose.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - app-network

  backend:
    image: ${BACKEND_IMAGE:?Set BACKEND_IMAGE to the backend container image reference}
    environment:
      - PORT=5001
      - CLIENT_ORIGIN=http://localhost:8080
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:?Set GOOGLE_CLIENT_ID to the Google OAuth client ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:?Set GOOGLE_CLIENT_SECRET to the Google OAuth client secret}
      - GOOGLE_REDIRECT_URI=http://localhost:8080/auth/google/callback
      - GOOGLE_AUTH_SCOPES=openid,profile,email,https://www.googleapis.com/auth/yt-analytics.readonly,https://www.googleapis.com/auth/yt-analytics-monetary.readonly,https://www.googleapis.com/auth/youtube,https://www.googleapis.com/auth/youtubepartner
      - JWT_SECRET=replace-with-a-secure-random-string
      - JWT_EXPIRES_IN=7d
      - SESSION_COOKIE_NAME=ya_session
      - SESSION_COOKIE_SECURE=false
      - SESSION_COOKIE_SAMESITE=lax
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=yvapuser
      - DB_PASSWORD=youtube
      - DB_NAME=yvapp
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY:?Set YOUTUBE_API_KEY to your YouTube Data API key}
      - SPOTLIGHT_CHANNEL_HANDLES=NDWTB,xiao_lin_shuo,moyutogether,hellobailu,Leisadventure,WorldwithCK,anzhengming,MaxBookClub,laogao,达叔的财智日记
      - ENABLE_FETCH_PROXY=true
      - VIDEO_TS_SERVICE_BASE_URL=http://ai-video-transcriber:8000
      - VIDEO_TS_STREAM_TIMEOUT_MS=900000
      - MINIO_ENDPOINT=${BACKEND_IMAGE_MINIO_ENDPOINT}
      - MINIO_PORT=${BACKEND_IMAGE_MINIO_PORT}
      - MINIO_USE_SSL=${BACKEND_IMAGE_MINIO_USE_SSL}
      - MINIO_ACCESS_KEY=${BACKEND_IMAGE_MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${BACKEND_IMAGE_MINIO_SECRET_KEY}
      - MINIO_BUCKET=${BACKEND_IMAGE_MINIO_BUCKET}
      - MINIO_REGION=${BACKEND_IMAGE_MINIO_REGION}
      - MINIO_PRESIGN_EXPIRY_SECONDS=${BACKEND_IMAGE_MINIO_PRESIGN_EXPIRY_SECONDS}

    expose:
      - "5001"
    networks:
      - app-network

  ai-video-transcriber:
    image: ${AI_VIDEO_TRANSCRIBER_IMAGE:?Set AI_VIDEO_TRANSCRIBER_IMAGE to the container image reference}
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-your_openai_api_key_here}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-base}
      - HOST=0.0.0.0
      - PORT=8000
      - MINIO_ENDPOINT=${AI_VIDEO_MINIO_ENDPOINT}
      - MINIO_ACCESS_KEY=${AI_VIDEO_MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${AI_VIDEO_MINIO_SECRET_KEY}
      - MINIO_BUCKET=${AI_VIDEO_MINIO_BUCKET}
      - MINIO_REGION=${AI_VIDEO_MINIO_REGION}
      - MINIO_SECURE=${AI_VIDEO_MINIO_SECURE}
      - MINIO_PREFIX=${AI_VIDEO_MINIO_PREFIX}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
